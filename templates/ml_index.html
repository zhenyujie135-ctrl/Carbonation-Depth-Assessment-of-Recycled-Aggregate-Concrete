<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML-RAC碳化深度预测系统 | ML-based Carbonation Depth Prediction</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header .subtitle {
            font-size: 1.3em;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .header .version {
            background: rgba(255, 255, 255, 0.2);
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .input-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
        }

        .input-section h2::before {
            content: "⚙️";
            margin-right: 10px;
            font-size: 1.2em;
        }

        .optimal-params {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border: 2px solid #28a745;
            margin-bottom: 20px;
        }

        .optimal-params h2::before {
            content: "🎯";
        }

        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .input-group input {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .model-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .model-options select {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
            background: white;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-optimal {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .results-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .results-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
        }

        .results-section h2::before {
            content: "📊";
            margin-right: 10px;
            font-size: 1.2em;
        }

        .prediction-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .prediction-main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .prediction-value {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
        }

        .prediction-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .prediction-uncertainty {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .prediction-value h3 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .prediction-value p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .confidence-interval {
            background: #e8f4f8;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 15px 0;
        }

        .ml-analysis {
            margin-top: 20px;
        }

        .analysis-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .analysis-section h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .quality-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .quality-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .quality-item:last-child {
            border-bottom: none;
        }

        .quality-grade {
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        .grade-s { background: #d4edda; color: #155724; }
        .grade-a { background: #d1ecf1; color: #0c5460; }
        .grade-b { background: #fff3cd; color: #856404; }
        .grade-c { background: #f8d7da; color: #721c24; }

        .reliability {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            margin-top: 15px;
        }

        .reliability-high {
            background: #d4edda;
            color: #155724;
        }

        .reliability-medium {
            background: #fff3cd;
            color: #856404;
        }

        .reliability-low {
            background: #f8d7da;
            color: #721c24;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading::after {
            content: "⏳";
            font-size: 2em;
            display: block;
            margin-top: 10px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .input-grid, .model-options, .prediction-main, .quality-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .container {
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 ML-RAC碳化深度预测系统</h1>
            <p class="subtitle">Machine Learning based Carbonation Depth Prediction for Recycled Aggregate Concrete</p>
            <span class="version">🚀 基于实际ML模型理论分析 v2.0</span>
        </div>

        <div class="main-content">
            <!-- 输入参数部分 -->
            <div class="input-section">
                <!-- 最优参数区域 -->
                <div class="input-section optimal-params">
                    <h2>最优参数组合</h2>
                    <div style="text-align: center; margin-bottom: 15px;">
                        <button class="btn btn-optimal" onclick="loadOptimalParams()">
                            🎯 加载最优参数 (6.8%不确定性)
                        </button>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 5px; font-size: 0.9em; color: #495057;">
                        <strong>💡 提示：</strong>点击上方按钮自动加载经过ML模型优化的最优参数组合，可实现6.8%的超低相对不确定性预测。
                    </div>
                </div>

                <h2>输入参数</h2>
                
                <form id="predictionForm">
                    <div class="input-grid">
                        <div class="input-group">
                            <label for="cement">水泥 (kg/m³)</label>
                            <input type="number" id="cement" step="0.1" min="0" value="300">
                        </div>
                        <div class="input-group">
                            <label for="fly_ash">粉煤灰 (kg/m³)</label>
                            <input type="number" id="fly_ash" step="0.1" min="0" value="130">
                        </div>
                        <div class="input-group">
                            <label for="water">水 (kg/m³)</label>
                            <input type="number" id="water" step="0.1" min="0" value="150">
                        </div>
                        <div class="input-group">
                            <label for="coarse_agg">粗骨料 (kg/m³)</label>
                            <input type="number" id="coarse_agg" step="0.1" min="0" value="950">
                        </div>
                        <div class="input-group">
                            <label for="recycled_agg">再生骨料 (kg/m³)</label>
                            <input type="number" id="recycled_agg" step="0.1" min="0" value="250">
                        </div>
                        <div class="input-group">
                            <label for="water_absorption">吸水率 (%)</label>
                            <input type="number" id="water_absorption" step="0.1" min="0" value="2.5">
                        </div>
                        <div class="input-group">
                            <label for="fine_agg">细骨料 (kg/m³)</label>
                            <input type="number" id="fine_agg" step="0.1" min="0" value="680">
                        </div>
                        <div class="input-group">
                            <label for="superplasticizer">减水剂 (kg/m³)</label>
                            <input type="number" id="superplasticizer" step="0.1" min="0" value="5.0">
                        </div>
                        <div class="input-group">
                            <label for="compressive_strength">抗压强度 (MPa)</label>
                            <input type="number" id="compressive_strength" step="0.1" min="0" value="50">
                        </div>
                        <div class="input-group">
                            <label for="carbon_concentration">碳浓度 (%)</label>
                            <input type="number" id="carbon_concentration" step="0.1" min="0" value="10">
                        </div>
                        <div class="input-group">
                            <label for="exposure_time">暴露时间 (天)</label>
                            <input type="number" id="exposure_time" step="1" min="0" value="28">
                        </div>
                        <div class="input-group">
                            <label for="temperature">温度 (°C)</label>
                            <input type="number" id="temperature" step="0.1" value="20">
                        </div>
                        <div class="input-group">
                            <label for="relative_humidity">相对湿度 (%)</label>
                            <input type="number" id="relative_humidity" step="0.1" min="0" max="100" value="60">
                        </div>
                    </div>

                    <div class="model-options">
                        <div class="input-group">
                            <label for="model">ML模型</label>
                            <select id="model">
                                <option value="XGB">XGBoost (R²=0.934)</option>
                                <option value="RF">Random Forest (R²=0.921)</option>
                                <option value="GB">Gradient Boosting (R²=0.918)</option>
                                <option value="SVR">Support Vector Regression (R²=0.896)</option>
                                <option value="KNN">K-Nearest Neighbors (R²=0.883)</option>
                                <option value="PRR">Polynomial Ridge (R²=0.847)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="confidence_level">置信水平</label>
                            <select id="confidence_level">
                                <option value="0.90">90%</option>
                                <option value="0.95" selected>95%</option>
                                <option value="0.99">99%</option>
                            </select>
                        </div>
                    </div>

                    <button type="button" class="btn" onclick="predict()">
                        🚀 开始预测
                    </button>
                </form>
            </div>

            <!-- 结果展示部分 -->
            <div class="results-section">
                <h2>预测结果与ML分析</h2>
                <div id="prediction-results">
                    <div class="loading">
                        等待预测结果...
                        <p style="margin-top: 10px; font-size: 0.9em;">请输入参数并点击"开始预测"</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 加载最优参数
        function loadOptimalParams() {
            fetch('/optimal')
                .then(response => response.json())
                .then(data => {
                    const params = data.optimal_params;
                    
                    // 填充表单
                    Object.keys(params).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = params[key];
                        }
                    });
                    
                    // 提示用户
                    alert('✅ 最优参数已加载！\n预期相对不确定性: ' + data.expected_uncertainty + '\n可靠性: ' + data.reliability);
                })
                .catch(error => {
                    console.error('Error loading optimal parameters:', error);
                    alert('❌ 加载最优参数失败，请稍后重试。');
                });
        }

        // 预测函数
        function predict() {
            const formData = {
                input_params: {
                    cement: parseFloat(document.getElementById('cement').value),
                    fly_ash: parseFloat(document.getElementById('fly_ash').value),
                    water: parseFloat(document.getElementById('water').value),
                    coarse_agg: parseFloat(document.getElementById('coarse_agg').value),
                    recycled_agg: parseFloat(document.getElementById('recycled_agg').value),
                    water_absorption: parseFloat(document.getElementById('water_absorption').value),
                    fine_agg: parseFloat(document.getElementById('fine_agg').value),
                    superplasticizer: parseFloat(document.getElementById('superplasticizer').value),
                    compressive_strength: parseFloat(document.getElementById('compressive_strength').value),
                    carbon_concentration: parseFloat(document.getElementById('carbon_concentration').value),
                    exposure_time: parseInt(document.getElementById('exposure_time').value),
                    temperature: parseFloat(document.getElementById('temperature').value),
                    relative_humidity: parseFloat(document.getElementById('relative_humidity').value)
                },
                model: document.getElementById('model').value,
                method: 'J+',
                confidence_level: parseFloat(document.getElementById('confidence_level').value)
            };

            // 显示加载状态
            document.getElementById('prediction-results').innerHTML = '<div class="loading">正在计算预测结果...</div>';

            // 发送预测请求
            fetch('/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                displayResults(data);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('prediction-results').innerHTML = 
                    '<div class="error-message">❌ 预测失败: ' + error.message + '</div>';
            });
        }

        // 显示结果
        function displayResults(data) {
            if (!data.success) {
                document.getElementById('prediction-results').innerHTML = 
                    '<div class="error-message">❌ 预测失败: ' + data.error + '</div>';
                return;
            }

            const analysis = data.ml_analysis;
            const quality = analysis.mix_design_quality;
            const performance = analysis.ml_performance;
            const uncertainty = analysis.uncertainty_breakdown;

            // 确定可靠性等级样式
            let reliabilityClass = 'reliability-medium';
            if (data.relative_uncertainty <= 15) {
                reliabilityClass = 'reliability-high';
            } else if (data.relative_uncertainty >= 30) {
                reliabilityClass = 'reliability-low';
            }

            // 确定质量等级样式
            let gradeClass = 'grade-c';
            if (quality.quality_grade.includes('S+')) gradeClass = 'grade-s';
            else if (quality.quality_grade.includes('A')) gradeClass = 'grade-a';
            else if (quality.quality_grade.includes('B')) gradeClass = 'grade-b';

            const resultsHtml = `
                <div class="prediction-card">
                    <div class="prediction-main">
                        <div class="prediction-value prediction-primary">
                            <h3>${data.prediction} mm</h3>
                            <p>预测碳化深度</p>
                        </div>
                        <div class="prediction-value prediction-uncertainty">
                            <h3>${data.relative_uncertainty}%</h3>
                            <p>相对不确定性</p>
                        </div>
                    </div>
                    
                    <div class="confidence-interval">
                        <strong>📊 ${(data.confidence_level * 100)}% 置信区间:</strong> 
                        [${data.lower_bound} mm, ${data.upper_bound} mm] 
                        (宽度: ${data.interval_width} mm)
                    </div>
                    
                    <div class="reliability ${reliabilityClass}">
                        ${analysis.prediction_reliability}
                    </div>
                </div>

                <div class="ml-analysis">
                    <div class="analysis-section">
                        <h4>🎨 配合比质量分析</h4>
                        <div class="quality-grid">
                            <div class="quality-item">
                                <span>水胶比:</span>
                                <span>${quality.w_c_ratio}</span>
                            </div>
                            <div class="quality-item">
                                <span>粉煤灰掺量:</span>
                                <span>${quality.fa_content}%</span>
                            </div>
                            <div class="quality-item">
                                <span>再生骨料替代率:</span>
                                <span>${quality.ra_replacement}%</span>
                            </div>
                            <div class="quality-item">
                                <span>质量等级:</span>
                                <span class="quality-grade ${gradeClass}">${quality.quality_grade}</span>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-section">
                        <h4>🤖 ML模型性能</h4>
                        <div class="quality-grid">
                            <div class="quality-item">
                                <span>选择模型:</span>
                                <span>${performance.selected_model}</span>
                            </div>
                            <div class="quality-item">
                                <span>预期R²:</span>
                                <span>${performance.expected_r2}</span>
                            </div>
                            <div class="quality-item">
                                <span>模型RMSE:</span>
                                <span>${performance.model_rmse} mm</span>
                            </div>
                            <div class="quality-item">
                                <span>不确定性因子:</span>
                                <span>${performance.uncertainty_factor}</span>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-section">
                        <h4>📊 不确定性分解</h4>
                        <div class="quality-grid">
                            <div class="quality-item">
                                <span>基础不确定性:</span>
                                <span>${uncertainty.base_uncertainty}%</span>
                            </div>
                            <div class="quality-item">
                                <span>模型修正:</span>
                                <span>${uncertainty.model_correction}</span>
                            </div>
                            <div class="quality-item">
                                <span>试验稳定性:</span>
                                <span>${uncertainty.experimental_stability}</span>
                            </div>
                            <div class="quality-item">
                                <span>最终不确定性:</span>
                                <strong>${uncertainty.final_uncertainty}%</strong>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('prediction-results').innerHTML = resultsHtml;
        }

        // 页面加载完成后自动加载最优参数
        window.addEventListener('load', function() {
            loadOptimalParams();
        });
    </script>
</body>
</html>